<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="" />
    <meta
      name="author"
      content="Mark Otto, Jacob Thornton, and Bootstrap contributors"
    />
    <meta name="generator" content="Hugo 0.88.1" />
    <title>Tapping testing UI3.0</title>
    <!-- <title>Jumbotron example Â· Bootstrap v5.1</title> -->

    <!-- Bootstrap core CSS -->
    <link
      href="bootstrap-5.1.3-dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      .bd-placeholder-img {
        font-size: 1.125rem;
        text-anchor: middle;
        -webkit-user-select: none;
        -moz-user-select: none;
        user-select: none;
      }

      @media (min-width: 768px) {
        .bd-placeholder-img-lg {
          font-size: 3.5rem;
        }
      }

      #volumeThreshold {
        width: 30%;
      }

      #validSpan,
      #specturmSlice {
        width: 10%;
      }

      #d {
        height: 10px;
      }
      #d:after {
        content: "";
        display: inline-block;
        height: 100px;
        width: px;
      }

      #d div {
        display: inline-block;
        width: 0.5px;
        background: #a00;
        margin: 0 0 0 1px;
        vertical-align: bottom;
      }

      #FFTCap {
        height: 25px;
      }
      #FFTCap:after {
        content: "";
        display: inline-block;
        height: 100px;
        width: px;
      }

      #FFTCap div {
        display: inline-block;
        width: 0.5px;
        background: #a00;
        margin: 0 0 0 1px;
        vertical-align: bottom;
      }

      #blankRemain {
        height: 80px;
      }

      #modelResult {
        width: 800px;
      }

      #newArray {
        width: 100%;
        border: 5px solid gray;
        height: 50px;
        overflow: auto;
      }

      #arraysBox,
      #resultLog {
        width: 100%;
        border: 5px solid gray;
        height: 150px;
        overflow: auto;
      }
    </style>
  </head>
  <body>
    <main>
      <div class="container py-4">
        <header class="pb-3 mb-4 border-bottom">
          <a
            href="/"
            class="d-flex align-items-center text-dark text-decoration-none"
          >
            <span class="fs-4"
              ><h1 class="display-5 fw-bold">Tapping Test</h1>
            </span>
          </a>
        </header>

        <button class="btn btn-primary btn-lg" type="button" id="p">
          play
        </button>
        <button class="btn btn-primary btn-lg" type="button" id="s">
          pause
        </button>

        <div class="p-1 mb-4 bg-light rounded-3">
          <div class="container-fluid py-1">
            <h1 class="display-5 fw-bold">Dash Board</h1>
            <h5>Real time response:</h5>
            <div id="d"></div>
            <p id="blankRemain"></p>
            <p>Total count: <span id="Count">0</span></p>

            <!-- <div id="FFTCap"><p>FFT Snap</p></div> -->
            <h5>FFT Snap:</h5>
            <span id="FFTCap"></span>
            <h5>New array:</h5><div id="newArray"></div>
            
          </div>
        </div>

        <div class="row align-items-md-stretch">
          <div class="col-md-6">
            <div class="p-3 text-white bg-dark rounded-3">
              <h1 class="display-5 fw-bold">Control Area</h1>
              <div>
                <input type="radio" id="teach" name="mode" />
                <label for="teach">Teach Mode</label>

                <input type="radio" id="real" name="mode" />
                <label for="real">Real Mode</label>
              </div>

              <div id="teachMode"></div>

              <!-- some teach array button -->
              <p id="teachArrayCal"></p>

              <p id="realMode"></p>
              <p id="initializeButton"></p>
              <p id="initialize"></p>

              <h3>Settings:</h3>

              <!-- Volume threshold value -->
              <div>
                <input
                  type="range"
                  min="1"
                  max="60000"
                  value="30000"
                  id="volumeThreshold"
                />
                <span>Volume threshold value: </span
                ><span
                  id="volumeThresholdValue"
                  style="font-weight: bold; color: red"
                ></span>
              </div>

              <!-- Spectrum valid span -->
              <div>
                <input type="text" value="320" id="validSpan" />
                <span>Spectrum valid span: </span>
                <span
                  id="validSpanValue"
                  style="font-weight: bold; color: red"
                ></span>
                <span>Hz ( Value should be in 0 ~ 1024 Hz) </span>
              </div>

              <!-- One slice contain -->
              <div>
                <input type="text" value="10" id="specturmSlice" />
                <span>One slice contain: </span>
                <span
                  id="spectrumSliceValue"
                  style="font-weight: bold; color: red"
                ></span>
                <span
                  >Hz (It will give <span id="specturmSliceCount"></span> slices
                  )</span
                >
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <!-- <div class="h-200 p-5 bg-light border rounded-3"> -->
            <div class="p-3 bg-light border rounded-3">
              <h1 class="display-6 fw-bold">Event log</h1>
              <h5>Teach array list:</h5>
              <div id="arraysBox">
                <p><br /><span id="teachArrays"></span></p>
              </div>

              <h5>Log:</h5>
                  <textarea
                    name="resultLog"
                    id="resultLog"
                    cols="50"
                    rows="10"
                  ></textarea>
              </div>
            </div>
          </div>
        </div>

        <footer class="pt-3 mt-4 text-muted border-top">&copy; 2021</footer>
      </div>

      <script>
        window.AudioContext = window.AudioContext || window.webkitAudioContext;
        navigator.getUserMedia =
          navigator.getUserMedia || navigator.webkitGetUserMedia;

        var freeze = 0; // for gate function
        var teachArrayCount = 1; // for teach array count
        var originTeachArrays = "";

        var d = document.getElementById("d");
        var FFTCap = document.getElementById("FFTCap");
        for (var i = 0; i < 512; i++) {
          d.innerHTML += "<div></div>";
          FFTCap.innerHTML += "<div></div>";
        }
        var dd = document.querySelectorAll("#d div");
        var FFTCapAll = document.querySelectorAll("#FFTCap div");

        var s = document.getElementById("s");
        var p = document.getElementById("p");
        var timer;
        var context = new AudioContext();
        // console.log("audioContext=%o", AudioContext);

        //////// control area ////////
        // volume threshold
        var volume = document.getElementById("volumeThreshold");
        var volumeOutput = document.getElementById("volumeThresholdValue");
        volumeOutput.innerHTML = volume.value;
        volume.oninput = function () {
          volumeOutput.textContent = this.value;
        };

        // Spectrum valid span
        document.getElementById("validSpanValue").innerText =
          document.getElementById("validSpan").value;
        document.getElementById("validSpan").oninput = function () {
          document.getElementById("validSpanValue").textContent = this.value;
          document.getElementById("specturmSliceCount").textContent =
            document.getElementById("validSpan").value /
            document.getElementById("specturmSlice").value;
        };

        // specturm slice times
        var specturm_slice = document.getElementById("specturmSlice");
        document.getElementById("spectrumSliceValue").innerText =
          specturm_slice.value;
        document.getElementById("specturmSliceCount").innerText =
          document.getElementById("validSpan").value / specturm_slice.value;
        specturm_slice.oninput = function () {
          document.getElementById("spectrumSliceValue").textContent =
            this.value;
          document.getElementById("specturmSliceCount").textContent =
            document.getElementById("validSpan").value / this.value;
        };

        // delete certain array on teach array list (It will be called by button(id=ButtonteachDelete))
        function deleteCertainArray(ArrayNumber) {
          var teachArrayParent = document.getElementById("teachArrays");
          var teachArrayChild = document.getElementById(
            "teachArrayNumber" + ArrayNumber
          );
          teachArrayParent.removeChild(teachArrayChild);
        }

        // teach array send to python
        function teachArraySend(dataArray, teachArrayCount) {
          if (document.getElementById("teach").checked == true) {
            // teach mode
            if (document.getElementById("teachGood").checked == true) {
              // teach Good sound
              originTeachArrays +=
                "Delete " + teachArrayCount + ",1," + dataArray;
            } else if (document.getElementById("teachBad").checked == true) {
              //teach bad sound
              originTeachArrays +=
                "Delete " + teachArrayCount + ",0," + dataArray;
            }
          }
          return originTeachArrays;
        }

        //////////////////////////////

        navigator.mediaDevices
          .getUserMedia({ audio: true, video: false })
          .then(function (stream) {
            var microphone = context.createMediaStreamSource(stream);
            var analyser = context.createAnalyser();
            microphone.connect(analyser);
            //analyser.connect(context.destination);

            analyser.fftSize = 1024;
            var bufferLength = analyser.frequencyBinCount;
            var dataArray = new Uint8Array(analyser.fftSize);
            analyser.getByteFrequencyData(dataArray); // FFT

            update();
            context.resume();
            s.onclick = function () {
              clearTimeout(timer); // cancels a timeout previously
            };

            p.onclick = function () {
              update();
              context.resume(); // See also: https://www.crifan.com/js_chrome_warning_the_audiocontext_was_not_allowed_to_start/
            };

            real.onclick = function () {
              document.getElementById("realMode").innerHTML =
                "<label for='selectModelFile'>Please select mode: </label><input type='file' id='selectModelFile' name='selectModelFile'>";
              var input = document.querySelector("#selectModelFile");
              input.addEventListener("change", checkFileExist);
              function checkFileExist() {
                let file = document.getElementById("selectModelFile");
                let fileName = file.value.replace(/.*[\/\\]/, "");

                document.getElementById("initializeButton").innerHTML =
                  fileName +
                  ' <button id="startInitialize">Initialize?</button>';

                startInitialize.onclick = function () {
                  document.getElementById("resultLog").innerHTML +=
                    "Start initializing on real mode...\n";
                };

                // startInitialize.onclick = function () {
                //   let needAppend = document.createTextNode(
                //     " Start initializing..."
                //   );
                //   document.getElementById("initialize").appendChild(needAppend);
                // };
              }
              document.getElementById("teachMode").innerHTML = "";
              document.getElementById("teachArrayCal").innerHTML = "";
            };
            teach.onclick = function () {
              document.getElementById("teachMode").innerHTML = `
                <input type="radio" id="teachGood" name="goodBad" />
                <label for="teach">Good Sound</label>

                <input type="radio" id="teachBad" name="goodBad" />
                <label for="teachBad">Bad Sound</label>
                `;
              document.getElementById("realMode").innerHTML = "";
              document.getElementById("initializeButton").innerHTML = "";
            };

            // update();

            function update() {
              // console.log(dataArray);
              analyser.getByteFrequencyData(dataArray);
              var totalCount = 0;
              for (var j = 0; j < 512; j++) {
                dd[j].style.height = dataArray[j] / 2 + "px";
                dd[j].style.background =
                  "rgba(" + (255 - j) + "," + j * 2 + ",0,1)";
                totalCount += dataArray[j];
              }

              ////////////////////////////////////////////////////////////
              // console.log(totalCount);
              var count = document.getElementById("Count");
              count.innerHTML = totalCount;
              gate(totalCount, dataArray);

              ////////////////////////////////////////////////////////////

              timer = setTimeout(update, 100); // sets a timer once the timer expires
            }

            ////////////////////////////////////////////////////////////
            // Gate for knocking sound
            function gate(totalCount, dataArray) {
              if (
                totalCount > volume.value &&
                freeze === 0 &&
                document
                  .getElementById("resultLog")
                  .textContent.indexOf(
                    "Teach arrays are under calculating..."
                  ) === -1 // check whether "calculating..." is showing on log area, if no go inside
              ) {
                var indicesOfDataArray = 12;
                teachArraySend(dataArray, teachArrayCount);
                teachArrayShow(dataArray, indicesOfDataArray);
                FFTCapture(dataArray);
                document.getElementById("newArray").textContent =
                  dataArray + " ......";
                  freeze = 1;
              } else if (totalCount > volume.value && freeze === 0 && document
                  .getElementById("resultLog").textContent.includes("Teach arrays are under calculating...") === true // check whether "calculating..." is showing on log area, if yes go inside
                  ) {
                    FFTCapture(dataArray);
                    document.getElementById("newArray").textContent = dataArray + " ......";
                    freeze = 1
              } else if (totalCount > volume.value && freeze === 1){
              } else {
                freeze = 0;
              }
            }

            // Capture knocking frequency
            function FFTCapture(dataArray) {
              // var Capture = document.getElementById("FFTCap");
              // Capture.innerHTML = dataArray;

              for (var j = 0; j < 512; j++) {
                FFTCapAll[j].style.height = dataArray[j] / 2 + "px";
                FFTCapAll[j].style.background =
                  "rgba(" + (255 - j) + "," + j * 2 + ",0,1)";
              }
              return dataArray
            }

            // show teach arrays on teach array list
            function teachArrayShow(dataArray, indicesOfDataArray) {
              if (document.getElementById("teach").checked == true) {
                // teach mode
                if (document.getElementById("teachGood").checked == true) {
                  // teach Good sound

                  var teachDelete = document.createElement("span");
                  teachDelete.setAttribute(
                    "id",
                    "teachArrayNumber" + teachArrayCount
                  );
                  teachDelete.innerHTML =
                    "<button id='ButtonteachDelete" +
                    teachArrayCount +
                    "' onclick='deleteCertainArray(" +
                    teachArrayCount +
                    ")'>Delete</button> <b>" +
                    teachArrayCount +
                    ",</b>1," +
                    dataArray.slice(0, indicesOfDataArray) +
                    " ......" +
                    "<br>" +
                    "</span>";
                  document
                    .getElementById("teachArrays")
                    .appendChild(teachDelete); // append new array to arrays list
                  teachArrayCount += 1;
                } else if (
                  document.getElementById("teachBad").checked == true
                ) {
                  //teach bad sound
                  var teachDelete = document.createElement("span");
                  teachDelete.setAttribute(
                    "id",
                    "teachArrayNumber" + teachArrayCount
                  );
                  teachDelete.innerHTML =
                    "<button id='ButtonteachDelete" +
                    teachArrayCount +
                    "' onclick='deleteCertainArray(" +
                    teachArrayCount +
                    ")'>Delete</button> <b>" +
                    teachArrayCount +
                    ",</b>0," +
                    dataArray.slice(0, indicesOfDataArray) +
                    " ......" +
                    "<br>" +
                    "</span>";
                  document
                    .getElementById("teachArrays")
                    .appendChild(teachDelete);
                  teachArrayCount += 1;
                }
              }

              // if there are some arrays, then show "calculate" and "delete all" buttons
              if (document.getElementById("teachArrays").textContent !== "") {
                document.getElementById("teachArrayCal").innerHTML =
                  '<button id="teachStartCalButton">Calculate</button>' +
                  '<button id="arraysDelButton">Delete all arrays</button>';
                // if "start calculation button" been pressed, then show "Calculating..." below
                teachStartCalButton.onclick = function () {
                  document.getElementById("resultLog").innerHTML +=
                    "Teach arrays are under calculating...\n"; ///////////////////////////////////////////////////////////////////////////////////////////////////////////////connection//
                };
                // if "del array button" been pressed, clear the arrays
                arraysDelButton.onclick = function () {
                  document.getElementById("teachArrays").textContent = "";
                };
              }
            }


          })
          .catch(function () {
            console.log("error");
          });
      </script>
    </main>
  </body>
</html>
